---
/**
 * BlogListLayout - 共享的博客列表布局组件
 * 用于 /blog 和 /tags/[tag] 页面，确保布局一致性
 */
import BaseHead from "./BaseHead.astro";
import Footer from "./Footer.astro";
import Header from "./Header.astro";
import TagSidebar from "./TagSidebar.astro";
import PersonalProfile from "./PersonalProfile.astro";
import BlogSearch from "./BlogSearch.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";

interface Props {
    title?: string;
    subtitle?: string;
    description?: string;
    tags: Array<{ name: string; count: number }>;
    currentTag?: string;
    searchPosts: Array<{
        id: string;
        title: string;
        description: string;
        pubDate: string;
        href: string;
    }>;
}

const {
    title = SITE_TITLE,
    subtitle,
    description = SITE_DESCRIPTION,
    tags,
    currentTag,
    searchPosts,
} = Astro.props;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={title} description={description} />
        <style>
            .page-wrapper {
                max-width: 1400px;
                margin: 0 auto;
                padding: var(--sidebar-top) 2rem 2.5rem;
                --page-max: 1400px;
                --page-pad: 2rem;
                --header-height: 58px;
                --sidebar-top: calc(var(--header-height) + 2rem);
                --page-gutter: max(
                    var(--page-pad),
                    calc((100vw - var(--page-max)) / 2 + var(--page-pad))
                );
            }
            .container {
                display: grid;
                --side-min: 200px;
                --side-max: 220px;
                --side-width: clamp(var(--side-min), 22vw, var(--side-max));
                grid-template-columns: var(--side-width) minmax(0, 1fr) var(--side-width);
                gap: clamp(2.5rem, 4vw, 4rem);
                align-items: start;
                padding-top: 0;
            }
            .left-space {
                position: relative;
                align-self: start;
            }
            .left-fixed {
                position: fixed;
                top: var(--blog-fixed-top, var(--sidebar-top));
                left: var(--page-gutter);
                width: var(--side-width);
            }
            .right-space {
                position: relative;
                align-self: start;
            }
            .right-fixed {
                position: fixed;
                top: var(--blog-fixed-top, var(--sidebar-top));
                right: var(--page-gutter);
                width: var(--side-width);
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
            }
            :global(.right-fixed .tag-sidebar) {
                margin-top: 0;
                width: 100%;
                box-sizing: border-box;
            }
            :global(.left-fixed .personal-profile) {
                width: 100%;
                box-sizing: border-box;
            }
            .footer-row {
                grid-column: 1 / -1;
                width: 100vw;
                margin-left: calc(50% - 50vw);
            }
            .blog-main {
                min-width: 0;
                width: 100%;
                max-width: 780px;
                justify-self: center;
                padding: 0;
                margin: 0;
            }
            .blog-title {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                margin: 0 0 2.5rem;
            }
            .blog-title h1 {
                font-size: clamp(2.2rem, 3vw, 2.6rem);
                letter-spacing: -0.02em;
            }
            .blog-title p {
                margin: 0;
                font-size: 1.05rem;
                color: rgb(var(--ink-muted));
                max-width: 40ch;
            }
            .posts-list {
                display: grid;
                grid-template-columns: 1fr;
                gap: 2rem;
                list-style-type: none;
                margin: 0;
                padding: 0;
            }
            .posts-list li {
                width: 100%;
            }
            @media (max-width: 1024px) {
                .container {
                    grid-template-columns: minmax(0, 1fr) var(--side-width);
                }
                .left-space {
                    display: none;
                }
                .right-fixed {
                    position: static;
                    width: auto;
                }
            }
            @media (max-width: 720px) {
                .page-wrapper {
                    padding: var(--sidebar-top) 1rem 2rem;
                }
                .container {
                    grid-template-columns: 1fr;
                }
                .right-fixed {
                    position: static;
                    width: 100%;
                }
                .blog-title {
                    margin-bottom: 2rem;
                }
                .blog-title p {
                    font-size: 1rem;
                }
                .posts-list {
                    gap: 1.5rem;
                }
            }
        </style>
    </head>
    <body>
        <Header />
        <div class="page-wrapper">
            <div class="container">
                <aside class="left-space">
                    <div class="left-fixed">
                        <PersonalProfile />
                    </div>
                </aside>
                <main class="blog-main">
                    <header class="blog-title">
                        <h1>{title}</h1>
                        {subtitle && <p>{subtitle}</p>}
                    </header>
                    <section>
                        <ul class="posts-list">
                            <slot />
                        </ul>
                    </section>
                </main>
                <aside class="right-space">
                    <div class="right-fixed">
                        <BlogSearch posts={searchPosts} />
                        <TagSidebar tags={tags} currentTag={currentTag} />
                    </div>
                </aside>
                <div class="footer-row">
                    <Footer />
                </div>
            </div>
        </div>
        <script is:inline data-astro-rerun>
            const updateBlogFixedTop = () => {
                const main = document.querySelector(".blog-main");
                if (!main) return;
                const header = document.querySelector("header");
                const headerBottom = header
                    ? header.getBoundingClientRect().bottom
                    : 58;
                const minTop = Math.max(64, Math.round(headerBottom + 16));
                const { top } = main.getBoundingClientRect();
                document.documentElement.style.setProperty(
                    "--blog-fixed-top",
                    `${Math.max(Math.round(top), minTop)}px`,
                );
            };

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", updateBlogFixedTop, {
                    once: true,
                });
            } else {
                updateBlogFixedTop();
            }

            window.addEventListener("load", updateBlogFixedTop, { once: true });
            window.addEventListener("pageshow", updateBlogFixedTop);
            document.addEventListener("astro:page-load", updateBlogFixedTop);
            window.addEventListener("resize", updateBlogFixedTop);
        </script>
    </body>
</html>
