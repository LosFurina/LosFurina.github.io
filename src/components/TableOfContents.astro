---
interface Heading {
    depth: number;
    slug: string;
    text: string;
}

interface Props {
    headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only show h2 and h3
const toc = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{
    toc.length > 0 && (
        <nav class="toc" aria-label="Table of Contents">
            <h4 class="toc-title">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    width="16"
                    height="16"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
                    />
                </svg>
                On this page
            </h4>
            <ul class="toc-list">
                {toc.map((heading) => (
                    <li class:list={["toc-item", `depth-${heading.depth}`]}>
                        <a href={`#${heading.slug}`} class="toc-link">
                            {heading.text}
                        </a>
                    </li>
                ))}
            </ul>
        </nav>
    )
}

<style>
    .toc {
        position: sticky;
        top: 6rem;
        max-height: calc(100vh - 8rem);
        overflow-y: auto;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid var(--border-soft);
        box-shadow: var(--shadow-soft);
        border-radius: 12px;
        font-size: 0.85rem;
    }

    :global([data-theme="dark"]) .toc {
        background: rgba(35, 30, 27, 0.7);
        border-color: var(--border-soft);
    }

    .toc-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0 0 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        color: rgb(var(--gray-dark));
    }

    .toc-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .toc-item {
        margin: 0;
        padding: 0;
    }

    .toc-item.depth-3 {
        padding-left: 1rem;
    }

    .toc-link {
        display: block;
        padding: 0.4rem 0;
        color: rgb(var(--gray));
        text-decoration: none;
        border-left: 2px solid transparent;
        padding-left: 0.75rem;
        margin-left: -0.75rem;
        transition: all 0.2s ease;
        line-height: 1.4;
    }

    .toc-link:hover {
        color: var(--accent);
        border-left-color: var(--accent);
    }

    .toc-link.active {
        color: var(--accent);
        font-weight: 500;
        border-left-color: var(--accent);
    }

    @media (max-width: 1200px) {
        .toc {
            position: relative;
            top: 0;
            max-height: none;
            margin-bottom: 2rem;
        }
    }
</style>

<script>
    // Highlight current section in TOC
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                const id = entry.target.getAttribute("id");
                const tocLink = document.querySelector(
                    `.toc-link[href="#${id}"]`,
                );

                if (entry.isIntersecting) {
                    // Remove active from all links
                    document
                        .querySelectorAll(".toc-link.active")
                        .forEach((link) => {
                            link.classList.remove("active");
                        });
                    // Add active to current link
                    tocLink?.classList.add("active");
                }
            });
        },
        {
            rootMargin: "-80px 0px -80% 0px",
            threshold: 0,
        },
    );

    // Observe all headings
    document
        .querySelectorAll("article h2[id], article h3[id]")
        .forEach((heading) => {
            observer.observe(heading);
        });
</script>
