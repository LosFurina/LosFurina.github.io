---
import { getCollection } from "astro:content";
import BlogCard from "../../components/BlogCard.astro";
import BlogListLayout from "../../components/BlogListLayout.astro";
import { BLOG_SUBTITLE, SITE_DESCRIPTION } from "../../consts";
import { getPrimaryTag } from "../../utils/blogTags";
import { filterVisiblePosts } from "../../utils/blogVisibility";

const posts = filterVisiblePosts(await getCollection("blog")).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 准备搜索用的数据
const searchPosts = posts.map((post) => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description,
	pubDate: post.data.pubDate.toISOString(),
	href: `/blog/${post.id}/`,
}));

const allPosts = filterVisiblePosts(await getCollection("blog"));

// 自动计算所有存在的文件夹（Tags）及其文章数量
const tagCounts = allPosts.reduce(
	(acc, post) => {
		const tag = post.id.includes("/") ? post.id.split("/")[0] : "untagged";
		acc[tag] = (acc[tag] || 0) + 1;
		return acc;
	},
	{} as Record<string, number>,
);

const tagsWithCount = Object.entries(tagCounts)
	.map(([name, count]) => ({
		name,
		count,
	}))
	.sort((a, b) => b.count - a.count);
---

<BlogListLayout
	title="Blog"
	subtitle={BLOG_SUBTITLE}
	description={SITE_DESCRIPTION}
	tags={tagsWithCount}
	searchPosts={searchPosts}
>
	{
		posts.map((post, index) => {
			const tag = getPrimaryTag(post.id);
			const tags = [{ name: tag, href: `/tags/${tag}` }];
			return (
				<li>
					<BlogCard
						title={post.data.title}
						pubDate={post.data.pubDate}
						description={post.data.description}
						heroImage={post.data.heroImage}
						href={`/blog/${post.id}/`}
						index={index}
						tags={tags}
					/>
				</li>
			);
		})
	}
</BlogListLayout>
