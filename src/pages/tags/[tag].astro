---
import { getCollection, type CollectionEntry } from "astro:content";
import BlogCard from "../../components/BlogCard.astro";
import BlogListLayout from "../../components/BlogListLayout.astro";
import { BLOG_SUBTITLE, SITE_DESCRIPTION } from "../../consts";
import { getPrimaryTag } from "../../utils/blogTags";
import { filterVisiblePosts } from "../../utils/blogVisibility";

export async function getStaticPaths() {
    const allPosts = filterVisiblePosts(await getCollection("blog"));
    const allTags = [
        ...new Set(
            allPosts.map((post) =>
                post.id.includes("/") ? post.id.split("/")[0] : "untagged",
            ),
        ),
    ];

    return allTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) => {
            if (tag === "untagged") {
                return !post.id.includes("/");
            }
            return post.id.startsWith(tag + "/");
        });
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts: rawPosts } = Astro.props as { posts: CollectionEntry<"blog">[] };

// 按日期排序
const posts = rawPosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 准备搜索用的数据
const searchPosts = posts.map((post) => ({
    id: post.id,
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate.toISOString(),
    href: `/blog/${post.id}/`,
}));

const allPosts = filterVisiblePosts(await getCollection("blog"));

// 计算每个标签的文章数量
const tagCounts = allPosts.reduce(
    (acc, post) => {
        const tagName = post.id.includes("/")
            ? post.id.split("/")[0]
            : "untagged";
        acc[tagName] = (acc[tagName] || 0) + 1;
        return acc;
    },
    {} as Record<string, number>,
);

const tagsWithCount = Object.entries(tagCounts)
    .map(([name, count]) => ({
        name,
        count,
    }))
    .sort((a, b) => b.count - a.count);
---

<BlogListLayout
    title={`Tag: ${tag}`}
    subtitle={BLOG_SUBTITLE}
    description={SITE_DESCRIPTION}
    tags={tagsWithCount}
    currentTag={tag}
    searchPosts={searchPosts}
>
    {
        posts.map((post, index) => {
            const tagName = getPrimaryTag(post.id);
            const tags = [{ name: tagName, href: `/tags/${tagName}` }];
            return (
                <li>
                    <BlogCard
                        title={post.data.title}
                        pubDate={post.data.pubDate}
                        description={post.data.description}
                        heroImage={post.data.heroImage}
                        href={`/blog/${post.id}/`}
                        index={index}
                        tags={tags}
                    />
                </li>
            );
        })
    }
</BlogListLayout>
